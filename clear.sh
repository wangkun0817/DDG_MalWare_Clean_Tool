#!/bin/bash

# 清理异常进程
process_clean(){
process_list=$(busybox ps -ef | busybox grep -v grep | busybox egrep 'ksoftirqds|watchdogs')

if [ -z ${process_list} ];then
    echo "not exits process"
else
    busybox ps -ef | busybox grep -v grep | busybox egrep 'ksoftirqds|watchdogs' | busybox awk '{print $1}' | busybox xargs kill -9
    echo "process clean ok"
fi
}

# 解除挖矿文件文件锁并删除
virus_bins_remove(){
chattr -i /etc/ld.so.preload /usr/local/lib/libioset.so /etc/ld.so.preload /tmp/watchdogs /etc/cron.d/tomcat /etc/cron.d/root /var/spool/cron/root /var/spool/cron/crontabs/root /etc/rc.d/init.d/watchdogs /usr/sbin/watchdogs > /dev/null 2>&1 &
busybox rm -f /etc/ld.so.preload
busybox rm -f /usr/local/lib/libioset.so
}

# 清理挖矿文件及二进制程序
virus_files_remove(){
busybox rm -f /tmp/watchdogs
busybox rm -f /etc/cron.d/tomcat
busybox rm -f /etc/cron.d/root
busybox rm -f /var/spool/cron/root
busybox rm -f /var/spool/cron/crontabs/root
busybox rm -f /etc/rc.d/init.d/watchdogs
busybox rm -f /usr/sbin/watchdogs
ldconfig
}



service crond stop
virus_bins_remove
process_clean
virus_files_remove
process_clean
# 清理开机启动项
chkconfig watchdogs off
chkconfig --del watchdogs
service crond start
echo "Done, Please reboot!"


# 1eaf@moresec
